<html>
  <head>
    <title>Astroid Blaster - SeeSeePortal</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>
        // Enhanced polyfills for Code.org Game Lab functions
        
        // Mock appOptions and pageConstants
        window.appOptions = {
            pageConstants: {
                channelId: 'local',
                isShareView: true,
                assetUrl: function(path) {
                    // Handle various Code.org path formats
                    if (!path || typeof path !== 'string') {
                        console.warn('Invalid asset path:', path);
                        return '';
                    }
                    
                    // Remove Code.org specific prefixes
                    if (path.startsWith('/v3/')) {
                        return 'assets/' + path.split('/').pop();
                    }
                    if (path.startsWith('/api/')) {
                        return 'assets/' + path.split('/').pop();
                    }
                    
                    // If it's already a relative path, use it
                    if (path.startsWith('assets/')) {
                        return path;
                    }
                    
                    return path;
                }
            },
            level: {
                assetUrl: function(path) {
                    return window.appOptions.pageConstants.assetUrl(path);
                }
            }
        };
        
        // Mock Dashboard
        window.Dashboard = {
            project: {
                getCurrentId: function() { return 'local'; }
            }
        };
        
        // Override playSound to prevent errors
        window.playSound = function(sound, loop) {
            try {
                var audio = new Audio(sound);
                if (loop) {
                    audio.loop = true;
                }
                audio.play().catch(function(e) {
                    console.log('Sound not available:', sound);
                });
            } catch(e) {
                console.log('Sound disabled:', sound);
            }
        };
        
        // Polyfill for timedLoop
        if (typeof timedLoop === 'undefined') {
            window.timedLoop = function(interval, callback) {
                setInterval(callback, interval);
            };
        }
        
        // Fix loadImage to handle Code.org paths
        var originalLoadImage = null;
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (window.loadImage && !originalLoadImage) {
                    originalLoadImage = window.loadImage;
                    window.loadImage = function(path, successCallback, failureCallback) {
                        if (path && typeof path === 'string') {
                            path = window.appOptions.pageConstants.assetUrl(path);
                        }
                        return originalLoadImage.call(this, path, successCallback, failureCallback);
                    };
                }
            }, 100);
        });
    </script>
    <script src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
    <script src="gamelab-api.js"></script>
    <link href="gamelab.css" rel="stylesheet" type="text/css">
    <script src="p5.js"></script>
    <script src="p5.play.js"></script>
    <script src="code.js"></script>
    <style>
      body.expo {
        background-color: black;
      }
      #sketch.expo.no-controls {
        top: 82px;
      }
      #studio-dpad-container {
        display: none !important;
      }
    </style>
  </head>
  <body class="web" style="margin:0; overflow:hidden; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; position:fixed; top:0; left:0; width:400px; height:565px;">
    <div id="sketch" class="web" style="position:absolute;"></div>
    <div id="soft-buttons" style="display: none">
      <button id="leftButton" disabled className="arrow">
      </button>
      <button id="rightButton" disabled className="arrow">
      </button>
      <button id="upButton" disabled className="arrow">
      </button>
      <button id="downButton" disabled className="arrow">
      </button>
    </div>
    <div id="studio-dpad-container" style="position:absolute; width:400px; bottom:5px; height:157px; overflow-y:hidden;">
    </div>
  </body>
</html>